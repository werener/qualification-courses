{% load static %}
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–°–æ–∑–¥–∞–Ω–∏–µ –æ—Ç—á–µ—Ç–æ–≤ - –°–∏—Å—Ç–µ–º–∞ –∫–æ–Ω—Ç—Ä–æ–ª—è –∫—É—Ä—Å–æ–≤</title>
    <link rel="stylesheet" href="{% static 'app/css/styles.css' %}">
    <style>
        .reports-container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .filters-section {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }
        
        .results-section {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .filter-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 25px;
            margin-bottom: 25px;
        }
        
        .form-actions {
            display: flex;
            gap: 15px;
            margin-top: 30px;
            flex-wrap: wrap;
        }
        
        .btn-pdf {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            color: white;
        }
        
        .btn-excel {
            background: linear-gradient(135deg, #27ae60, #229954);
            color: white;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 25px 0;
        }
        
        .stat-card {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            padding: 25px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .stat-number {
            font-size: 2.5em;
            font-weight: bold;
            margin-bottom: 8px;
        }
        
        .stat-label {
            font-size: 1em;
            opacity: 0.9;
        }
        
        .report-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            font-size: 14px;
        }
        
        .report-table th {
            background: #2c3e50;
            color: white;
            padding: 15px;
            text-align: left;
            font-weight: 600;
        }
        
        .report-table td {
            padding: 12px 15px;
            border-bottom: 1px solid #ecf0f1;
        }
        
        .report-table tr:hover {
            background-color: #f8f9fa;
        }
        
        .no-data {
            text-align: center;
            padding: 40px;
            color: #7f8c8d;
            font-style: italic;
        }
        
        .section-title {
            color: #2c3e50;
            margin-bottom: 20px;
            border-bottom: 2px solid #3498db;
            padding-bottom: 10px;
        }
        
        .date-inputs {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        
        @media (max-width: 768px) {
            .filter-row {
                grid-template-columns: 1fr;
            }
            
            .date-inputs {
                grid-template-columns: 1fr;
            }
            
            .form-actions {
                flex-direction: column;
            }
            
            .btn {
                flex: none;
            }
        }
    </style>
</head>
<body>
    <div class="reports-container">
        <header class="header">
            <h1>–°–æ–∑–¥–∞–Ω–∏–µ –æ—Ç—á–µ—Ç–Ω–æ—Å—Ç–∏</h1>
            <p>–§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç—á–µ—Ç–æ–≤ –ø–æ –∫—É—Ä—Å–∞–º –ø–æ–≤—ã—à–µ–Ω–∏—è –∫–≤–∞–ª–∏—Ñ–∏–∫–∞—Ü–∏–∏</p>
        </header>

        <div class="filters-section">
            <h2 class="section-title">–ü–∞—Ä–∞–º–µ—Ç—Ä—ã –æ—Ç—á–µ—Ç–∞</h2>
            <form method="get" id="reportForm">
                <div class="filter-row">
                    <div class="form-group">
                        <label for="course" class="required">–ö—É—Ä—Å –ø–æ–≤—ã—à–µ–Ω–∏—è –∫–≤–∞–ª–∏—Ñ–∏–∫–∞—Ü–∏–∏</label>
                        <select id="course" name="course" required>
                            <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫—É—Ä—Å</option>
                            {% for course in courses %}
                            <option value="{{ course.id }}" 
                                    {% if selected_course == course.id|stringformat:'i' %}selected{% endif %}>
                                {{ course.name }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>–ü–µ—Ä–∏–æ–¥ –æ—Ç—á–µ—Ç–Ω–æ—Å—Ç–∏</label>
                        <div class="date-inputs">
                            <div>
                                <label for="start_date" style="font-size: 0.9em; display: block; margin-bottom: 5px;">
                                    –î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞
                                </label>
                                <input type="date" id="start_date" name="start_date" 
                                       value="{{ selected_start_date }}">
                            </div>
                            <div>
                                <label for="end_date" style="font-size: 0.9em; display: block; margin-bottom: 5px;">
                                    –î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è
                                </label>
                                <input type="date" id="end_date" name="end_date" 
                                       value="{{ selected_end_date }}">
                            </div>
                        </div>
                    </div>
                </div>


                <div class="form-actions">
                    <button type="submit" class="btn btn-primary">
                        –°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å –æ—Ç—á–µ—Ç
                    </button>
                    <a href="{% url 'index' %}" class="btn btn-secondary">
                        ‚Üê –ù–∞–∑–∞–¥ –∫ —Ñ–æ—Ä–º–µ
                    </a>
                    
                    {% if report_data %}
                    <a href="{% url 'generate_pdf_report' %}?{{ request.GET.urlencode }}" 
                       class="btn btn-pdf" target="_blank">
                        üìÑ –°–∫–∞—á–∞—Ç—å PDF
                    </a>
                    <button type="button" class="btn btn-excel" onclick="exportToExcel()">
                        üìä –°–∫–∞—á–∞—Ç—å Excel
                    </button>
                    {% endif %}
                </div>
            </form>
        </div>

        {% if report_data %}
        <div class="results-section">
            <h2 class="section-title">–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –æ—Ç—á–µ—Ç–∞</h2>
            
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number">{{ report_data.total_participants }}</div>
                    <div class="stat-label">–í—Å–µ–≥–æ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">{{ report_data.courses_count }}</div>
                    <div class="stat-label">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫—É—Ä—Å–æ–≤</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">
                        {% if report_data.average_duration %}
                            {{ report_data.average_duration.days }}
                        {% else %}
                            -
                        {% endif %}
                    </div>
                    <div class="stat-label">–°—Ä. –ø—Ä–æ–¥–æ–ª–∂–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å (–¥–Ω–∏)</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">
                        {% if report_data.success_rate %}
                            {{ report_data.success_rate }}%
                        {% else %}
                            -
                        {% endif %}
                    </div>
                    <div class="stat-label">–£—Å–ø–µ—à–Ω—ã—Ö –∑–∞–≤–µ—Ä—à–µ–Ω–∏–π</div>
                </div>
            </div>

            <h3 style="color: #2c3e50; margin: 30px 0 20px 0;">–î–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ —É—á–∞—Å—Ç–Ω–∏–∫–∞–º</h3>
            
            {% if report_data.enrollments %}
            <div style="overflow-x: auto;">
                <table class="report-table">
                    <thead>
                        <tr>
                            <th>–§–ò–û —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞</th>
                            <th>–î–æ–ª–∂–Ω–æ—Å—Ç—å</th>
                            <th>–ö—É—Ä—Å</th>
                            <th>–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞</th>
                            <th>–î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è</th>
                            <th>ID –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏—è</th>
                            <th>–°—Ç–∞—Ç—É—Å</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for enrollment in report_data.enrollments %}
                        <tr>
                            <td><strong>{{ enrollment.employee.full_name }}</strong></td>
                            <td>{{ enrollment.employee.position|default:"-" }}</td>
                            <td>{{ enrollment.course.name }}</td>
                            <td>{{ enrollment.start_date|date:"d.m.Y" }}</td>
                            <td>{{ enrollment.end_date|date:"d.m.Y" }}</td>
                            <td><code>{{ enrollment.completion_id }}</code></td>
                            <td>
                                <span style="color: #27ae60; font-weight: bold;">‚úì –ó–∞–≤–µ—Ä—à–µ–Ω–æ</span>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="no-data">
                <h3>üìù –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è</h3>
                <p>–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä—ã —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏</p>
            </div>
            {% endif %}
        </div>
        {% endif %}
    </div>

    <script>
        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –º–∞–∫—Å–∏–º–∞–ª—å–Ω—É—é –¥–∞—Ç—É –∫–∞–∫ —Å–µ–≥–æ–¥–Ω—è
        document.addEventListener('DOMContentLoaded', function() {
            const today = new Date().toISOString().split('T')[0];
            const endDateField = document.getElementById('end_date');
            if (endDateField) {
                endDateField.max = today;
            }
            
            // –ï—Å–ª–∏ –≤—ã–±—Ä–∞–Ω–∞ –¥–∞—Ç–∞ –Ω–∞—á–∞–ª–∞, —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –º–∏–Ω–∏–º–∞–ª—å–Ω—É—é –¥–∞—Ç—É –æ–∫–æ–Ω—á–∞–Ω–∏—è
            const startDateField = document.getElementById('start_date');
            if (startDateField && endDateField) {
                startDateField.addEventListener('change', function() {
                    endDateField.min = this.value;
                });
            }
        });
        
        // –í–∞–ª–∏–¥–∞—Ü–∏—è —Ñ–æ—Ä–º—ã
        document.getElementById('reportForm').addEventListener('submit', function(e) {
            const course = document.getElementById('course').value;
            const startDate = document.getElementById('start_date').value;
            const endDate = document.getElementById('end_date').value;
            
            if (!course) {
                e.preventDefault();
                alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –∫—É—Ä—Å –¥–ª—è —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏—è –æ—Ç—á–µ—Ç–∞');
                return false;
            }
            
            if (startDate && e—Ç–∏–ødDate && startDate > endDate) {
                e.preventDefault();
                alert('–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø–æ–∑–∂–µ –¥–∞—Ç—ã –æ–∫–æ–Ω—á–∞–Ω–∏—è');
                return false;
            }
            
            return true;
        });
        
        // –ó–∞–≥–ª—É—à–∫–∞ –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞ –≤ Excel
        function exportToExcel() {
            alert('–§—É–Ω–∫—Ü–∏—è —ç–∫—Å–ø–æ—Ä—Ç–∞ –≤ Excel –±—É–¥–µ—Ç —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –≤ –±–ª–∏–∂–∞–π—à–µ–µ –≤—Ä–µ–º—è');
            // –í –±—É–¥—É—â–µ–º –∑–¥–µ—Å—å –±—É–¥–µ—Ç —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è —ç–∫—Å–ø–æ—Ä—Ç–∞ –¥–∞–Ω–Ω—ã—Ö –≤ Excel
        }
    </script>
</body>
</html>